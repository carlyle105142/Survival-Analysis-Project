---
title: "STA222-Midterm Project"
author: "Yichu Chen"
date: "11/1/2022"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(KMsurv)
library(survival)
library(ggplot2)
library(survminer)
require(plyr)
library(rms) 
```

# Survival Analysis: Effectiveness of New Cleansing Detergent In Controlling Burn Site Infection


> ## I. Introduction
     
For burn patients, infection control remains an essential component of their treatment as the burn wound can be highly susceptible to colonization by micro-organisms, which could lead to extended hospital stays or deaths in severe cases. In attempting to better control burn wound infection, a new antimicrobial detergent with 4 percent chlorhexidine gluconate was proposed as a substitute for the conventional method, a combination use of a 10 percent povidone-iodine (Betadine*) and total body bathing with bar soap. In this report, a statistical analysis based on Cox Proportional Hazard Model is conducted to investigate the effectiveness of the new method in terms of reducing the risk of wound infection. The data being used in the analysis is based on two previous cohort studies: in one study, patients were treated with the use of the new antimicrobial detergent; in another study, which was conducted earlier, patients were treated with the conventional method. A comparison based on the two sets of data will then be conducted. More detailed information can be found in the publication "Evaluation of Protocol Change in Burn-Care Management Using the Cox-Proportional Hazards Model With Time-Dependent Covariates" (Ichida, J. M et al., 1993). In our context, we will use the outcome of straphylocous aureaus infection as our response metric to determine if infection took place. A group of variables that provide information about race, gender, burn site, burn type, percentage of burned area, as well as time dependent variables for prophylactic antibiotic treatment and surgical excision of burned tissue, will be used as explanatory measures.



> ## II. Data Overview
    
    
The dataset consists of 154 observations and 18 columns, including 1 index variable, 4 numerical variables and 13 categorical variables. The index variable simply denotes the patient ID. Among the 4 numerical columns, 3 are time-to-event variables corresponding to the events of prophylactic antibiotic treatment, straphylocous aureaus infection and surgical excision; the other measures the percent of burned area. The 13 categorical variables provide relevant information about burn sites, burn types (chemical, scald, flame or electric), race (white or non-white), gender (male or female), treatment (routine or cleansing with detergent) and also whether or not prophylactic antibiotic treatment, straphylocous aureaus infection and surgical excision took place.


```{r, echo=FALSE}
data(burn)

# pre-processing
burn <- data.frame(burn,Treatment=factor(burn$Z1,labels=c("Routine","Cleansing")))
burn <- data.frame(burn,Gender=factor(burn$Z2,labels=c("Male","Female")))
burn <- data.frame(burn,Race=factor(burn$Z3,labels=c("Nonwhite","White")))
burn <- data.frame(burn,PercentBurned=burn$Z4)
burn <- data.frame(burn,SiteHead=factor(burn$Z5,labels=c("NotBurned","Burned")))
burn <- data.frame(burn,SiteButtock=factor(burn$Z6,labels=c("NotBurned","Burned")))
burn <- data.frame(burn,SiteTrunk=factor(burn$Z7,labels=c("NotBurned","Burned")))
burn <- data.frame(burn,SiteUpperLeg=factor(burn$Z8,labels=c("NotBurned","Burned")))
burn <- data.frame(burn,SiteLowerLeg=factor(burn$Z9,labels=c("NotBurned","Burned")))
burn <- data.frame(burn,SiteRespTract=factor(burn$Z10,labels=c("NotBurned","Burned")))
burn <- data.frame(burn,BurnType=factor(burn$Z11,labels=c("Chemical","Scald","Electric","Flame")))
```


> ## III. Exploratory Analysis


In this section, several questions should be addressed:     


* Does treatment significantly reduce the risk for infection (i.e. increase survival probability)?       

* Is there any association between percent of burned area and infection?     

* Do patients with difference gender or race tend to have different survival curve?      

* Does different burn type lead to significantly different survival curve?      

* Are antibiotic treatment or surgical excision survival impacted by treatment types?     

* Do patients with wounds at some burn site tend to have higher infection rate or Treatment rate?



Note that the term "survival probability" is defined as the probability of not getting straphylocous aureaus infection at a specific time, which is estimated based on the collected sample data; and the term "hazard rate" is defined as the probability of getting straphylocous aureaus infection at a specific time; "survival curve" or "survival function" measures the relationship between the survival probability and time (in days). In this section, we will also examine, for each statistically significant variable, whether or not the proportional hazard assumption holds in order to construct the Cox Proportional Hazards Model. If the assumption does not hold, stratification may be introduced as a remedy.        



#### 1. Does treatment significantly increase the survival probability?     


```{r}
burn.surv = Surv(time=burn$T3,event=burn$D3)
burn.KM <- survfit(burn.surv ~ Treatment, data = burn)

plot(burn.KM, col=1:2, lwd=1.5,
     main="Plot 1A: Kaplan-Meier estimate by Treatment",
     xlab="Survival time (Days)",
     ylab="Survival Probability")
abline(h=0.5, col=3, lty=2, lwd=2)

legend("bottomright",c("Routine Care","Total Body Cleansing"), col=1:2, lwd=1.5)

```
```{r}
tab = with(burn, table(Treatment, D3))
colnames(tab) = c("Infection: NO", "Infection: YES")
tab
```

Plot A shows the Kaplan-Meier estimate of the survival curves for both control group (routine care) and treatment group (total body cleansing with the new detergent). The estimated curves give a general picture of how the proportions of infected patients change over time. At the very beginning, control group and treatment group have nearly identical survival rate. From then on, treatment group tend to have higher survival probability than control group at any given day. By the end of the study, 40% of patients (28 out of 70) in the control group are infected; 23.81% of patients (20 out of 84) in the treatment group are infected. We establish the hypothesis based on the Kaplan-Meier curves that treatment group have significantly different infection survival from the control group. 

```{r}
survdiff(burn.surv~Treatment,data=burn)
```

We carry out hypothesis test with log-rank test, which compares the number of observed infected patients in each group against the number that would have been "expected" if the control group and treatment group had the same survival functions. The test yields a p-value of 0.05, which leads to the conclusion that treatment group has better infection survival than control group at $\alpha=0.05$. The next step is to check if proportional hazard assumption holds for the treatment variable.


```{r}
timevec <- 1:max(burn$T3)
burn.NA <- with(burn, survfit(burn.surv~Treatment,type="fleming-harrington"))

sf_routine <- stepfun(burn.NA[1]$time,c(1,burn.NA[1]$surv))
sf_treatment <- stepfun(burn.NA[2]$time,c(1,burn.NA[2]$surv))
cumhaz_routine <- -log(sf_routine(timevec))
cumhaz_treatment <- -log(sf_treatment(timevec))

plot(timevec,cumhaz_routine/cumhaz_treatment,type="l",ylab="Hazard Ratio",xlab="Time (Days)",ylim=c(0,6),
     main="Plot 1B: Hazard Ratio between Two Treament Types", lwd=1.5)
abline(h=1.5, col=2, lwd=1.5, lty=2)
legend("bottomright","Routine:Cleansing",lwd=1.5)

# note: nearly proportional, can directly be used in model
```
```{r}
cox.treatment = coxph(burn.surv~Treatment, data=burn)
plot(burn.KM, col=1, lwd=1.5,
     main="Plot 1C: Kaplan-Meier Estimate and Cox PH Model",
     xlab="Survival time (Days)",
     ylab="Survival Probability")

lines(survfit(cox.treatment, data.frame(Treatment=c("Routine","Cleansing"))), col=2, lty=2, lwd=2)
legend("bottomright",c("Kaplan-Meier Estimate", "Cox-PH Model"),col=1:2, lwd=c(2,2),lty=1:2)
```

In Plot 1B, the hazard ratio is calculated between control group and treatment group. It seems that the hazard ratio between two groups remain constant at around 1.5 (indicated by the red dashed line) over time, which suggests that patients receiving routine treatment are 50% more likely to get infected than patients receiving the total cleansing with the detergent. The sample hazard ratio eventually goes up to 3, which may have been caused by a lack of sufficient data for patients from treatment group who survived longer than 40 days. We will proceed by presuming that constant hazard ratio holds. Plot 1C demonstrates the theoretical survival curve under Cox-PH model and the estimate based on sample. It looks that the model does give a good fit for the survival rates for both groups.

```{r}
summary(cox.treatment)
```

The Cox-PH model-based hypothesis test for equal survival function yields a p-value of 0.056. We will not reject the null hypothesis that both groups have the same hazard at $\alpha=0.05$, and would reject it if set $\alpha=0.1$. Based on the model, our estimate is that treatment group has around 0.57 times the risk for infection compared to control group, on average. We are able to conclude with 95% confidence that the true risk of infection for the treatment group is from 32.1% to 101.4% of that for the control group. Note that fitting with the treatment variable alone does not give the most accurate result as we have not accounted for the simultaneous impact of other variables.


#### 2. Is there any association between percent of burned area and infection?     

```{r}
# Scatter plot: burn area vs. time to infection
with(burn[which(burn$D3==1),],plot(PercentBurned, T3,
     main="Plot 2A: Percentage of Burn Area vs. Time to Infection",
     xlab="Percent of Burned Area",
     ylab="Time to Infection"))

with(burn[which(burn$D3==1),], lines(lowess(PercentBurned, T3), col=2))
```



The above Plot 2A shows the relationship between percent of burned area and time to infection for those who are infected. There is some weak quadratic trend: with low percent of burned area, higher percentage is associated with longer time to infection; with high percent of burned area, higher percentage tend to coincide with less time to infection. The majority of patients were infected in less than 20 days. 


```{r}

# Boxplot: burn area vs. time to infection
with(burn, boxplot(PercentBurned ~ factor(D3), horizontal=TRUE,
                   ylab="Infection (0/1)",
                   xlab="Percent Burned",
                   main="Plot 2B: Percent of Burned Area vs. Infection Outcome")
     )
```

From Plot 2B, we can visually compare the five number summary, namely minimum, 25th quantile, median, 75th quantile and maximum, for patients with and without infection. The difference is noticeable: although both groups have similar minimum, patients who were not infected tend to have numerically smaller sample quantiles (25th, 50th, 75th, maximum) than patients who were infected (excluding outliers).        

```{r}
# Boxplot: burn area vs. time to infection
with(burn, boxplot(PercentBurned ~ Treatment, horizontal=TRUE,
                   ylab="Treatment",
                   xlab="Percent Burned",
                   main="Plot 2C: Percent of Burned Area vs. Treatment")
     )
```

Similarly, from Plot 2C, there is a trend that the percent of burned area for control group is higher than that for treatment group. One can observe obvious difference in 25th, 50th, 75th quantile and maximum (excluding outliers).     

```{r}
# test if adding burned area improves model X
test1 = with(burn, coxph(burn.surv ~ PercentBurned + Treatment))
test2 = with(burn, coxph(burn.surv ~ Treatment))
anova(test1, test2)

```

The above is the result yielded from the F-test with null hypothesis that "Percent of Burned Area can be dropped out of the model without significantly reducing model performance, when Treatment variable is already in the model". The test generated a p-value of 0.325, which leads to failure to reject the null hypothesis at $\alpha=0.05$. We therefore will not include percent of burned area as an explanatory measure in the Cox hazard model.

#### 3. Do patients with difference gender or race tend to have different survival curve?         
```{r}
gender.KM <- survfit(burn.surv ~ Gender, data = burn)
plot(gender.KM, col=1:2, lwd=1.5,
     main="Plot 3A: Kaplan-Meier estimate by Gender",
     xlab="Survival time (Days)",
     ylab="Survival Probability")
legend("bottomright",c("Male","Female"), col=1:2, lwd=1.5)
```
```{r}
race.KM <- survfit(burn.surv ~ Race, data = burn)
plot(race.KM, col=1:2, lwd=1.5,
     main="Plot 3B: Kaplan-Meier estimate by Race",
     xlab="Survival time (Days)",
     ylab="Survival Probability")
legend("bottomright",c("Non-White","White"), col=1:2, lwd=1.5)
```

```{r}
tab2 = with(burn, table(Race, D3))

colnames(tab2) = c("Infection: NO","Infection: YES")

tab2
# strata on race
```

The survival curve estimates for the two gender groups (male vs. female) and the two racial groups (white vs. non-white) are plotted above. The survival curves for male and female are relatively similar with a noticeable intersection at around day 30 to day 40. The survival curves for white and non-white patients, however, look very different. For the non-white group, their survival probability remains at 100% until day 40, when a sharp drop of over 20% took place. This may have been a result of the small sample size: out of 19 non-white patients, only 1 was infected; whereas for white patients, 47 out of 135 were infected. A key note here is that the survival estimate for the non-white group may not be accurate. We may assume that a significant difference in survival probability between white and non-white groups indeed exist, which will require further verification. We will not, however, add this variable into the Cox model, because its regression effect is so strong that it overshadows the regression effect of other variables.                         


```{r}
# test if KM curve for different gender are the same
survdiff(burn.surv~Gender,data=burn)
```

* The above hypothesis test with p=0.1 confirms that the survival functions for two gender groups do not differ significantly at $\alpha=0.05$.

```{r}
# test if KM curve for different race are the same
survdiff(burn.surv~Race,data=burn)
```

* The above hypothesis test with p=0.01 confirms that the survival functions for two racial groups differ significantly at $\alpha=0.05$.        


#### 4. Do different burn types lead to significantly different survival curve?        

```{r}

burn.NA.burntype <- with(burn, survfit(burn.surv~BurnType,type="fleming-harrington"))

plot(survfit(burn.surv~BurnType, data=burn), col=1:4, lwd=1.5,
     main="Plot 4A: Kaplan-Meiers estimate by Burn Type",
     xlab="Time (Days)", ylab="Survival Probability")

legend("bottomright", c("Chemical","Scald","Electric","Flame"), col=1:4, lwd=1.5)

sf_chem <- stepfun(burn.NA.burntype[1]$time,c(1,burn.NA.burntype[1]$surv))
sf_scald <- stepfun(burn.NA.burntype[2]$time,c(1,burn.NA.burntype[2]$surv))
sf_elec <- stepfun(burn.NA.burntype[3]$time,c(1,burn.NA.burntype[3]$surv))
sf_flame <- stepfun(burn.NA.burntype[4]$time,c(1,burn.NA.burntype[4]$surv))

cumhaz_chem <- -log(sf_chem(timevec))
cumhaz_scald <- -log(sf_scald(timevec))
cumhaz_elec <- -log(sf_elec(timevec))
cumhaz_flame <- -log(sf_flame(timevec))

plot(timevec, cumhaz_chem, type="l", lwd=1.5, col=1, main="Plot 4B: Cumulative Hazard for Burn Types",
     xlab="Time (Days)",ylab="Cumulative Hazard", ylim=c(0,0.8))
lines(timevec, cumhaz_scald, lwd=1.5, col=2)
lines(timevec, cumhaz_elec, lwd=1.5, col=3)
lines(timevec, cumhaz_flame, lwd=1.5, col=4)
legend("bottomright", c("Chemical","Scald","Electric","Flame"), col=1:4, lwd=1.5)

# note: not proportional, use strata
```
```{r}
tab3 = with(burn, table(BurnType, D3))
colnames(tab3) = c("Infection: NO","Infection: YES")
tab3
```

Plot 4A shows the survival functions for four different burn types; Plot 4B shows their cumulative hazards, which depicts the cumulative probability of infection at some given time. The survival functions for scald and electric burn types are very similar; their cumulative hazard rate tend to increase very drastically at the beginning during the first 10 days. In other words, patients with electric or scald burn have a high chance of infection at the initial week. The curves for chemical burn type exhibit similar behavior, but may not be as accurate due to small sample size. For patients burned by flame, their survival rate tend to have a more constant and gentle decline than the others. By the end of study, groups of patients with electric and flame burn types tend to have similar infection rate at around 60%; nonetheless, it will take almost 50 days for flame-burned group to get to 60% infection rate, whereas for electric-burned group, the time taken is less than 20 days. Chemical-burned and scald-burned groups have lower overall infection rates of 20% and 40%, respectively. One thing to note is that the sample sizes for chemical, scald and electric-burned patients are relatively small, which may induce statistical bias.            



```{r}

# proportionality of different burn type

par(mfrow=c(2,2), mar=c(2,2,3,1))


plot(timevec,cumhaz_chem/cumhaz_scald,type="l",ylab="Hazard Ratio",xlab="Time (Days)",ylim=c(0,1),
     main="Hazard Ratio: Chemical vs. Others", lwd=1.5, cex.main=0.8)
lines(timevec,cumhaz_chem/cumhaz_elec,lwd=1.5,col=2)
lines(timevec,cumhaz_chem/cumhaz_flame,lwd=1.5,col=3)
legend("bottomright",c("Chemical:Scald","Chemical:Electric","Chemical:Flame"), col=1:3, lwd=1.5, cex=0.5)


plot(timevec,cumhaz_scald/cumhaz_elec,type="l",ylab="Hazard Ratio",xlab="Time (Days)",ylim=c(0,4.5),
     main="Hazard Ratio: Scald vs. Others", lwd=1.5, cex.main=0.8)
lines(timevec,cumhaz_scald/cumhaz_chem, lwd=1.5,col=2)
lines(timevec,cumhaz_scald/cumhaz_flame,lwd=1.5,col=3)
legend("bottomright",c("Scald:Electirc","Scald:Chemical","Scald:Flame"), col=1:3, lwd=1.5, cex=0.5)

plot(timevec,cumhaz_elec/cumhaz_chem,type="l",ylab="Hazard Ratio",xlab="Time (Days)",ylim=c(0,15),
     main="Hazard Ratio: Electric vs. Others", lwd=1.5, cex.main=0.8)
lines(timevec,cumhaz_elec/cumhaz_scald, lwd=1.5,col=2)
lines(timevec,cumhaz_elec/cumhaz_flame,lwd=1.5,col=3)
legend("bottomright",c("Electric:Chemical","Electric:Scald","Electric:Flame"), col=1:3, lwd=1.5, cex=0.5)

plot(timevec,cumhaz_flame/cumhaz_chem,type="l",ylab="Hazard Ratio",xlab="Time (Days)",ylim=c(0,5),
     main="Hazard Ratio: Flame vs. Others", lwd=1.5, cex.main=0.8)
lines(timevec,cumhaz_flame/cumhaz_scald, lwd=1.5,col=2)
lines(timevec,cumhaz_flame/cumhaz_elec,lwd=1.5,col=3)
legend("bottomright",c("Flame:Chemical","Flame:Scald","Flame:Electric"), col=1:3, lwd=1.5, cex=0.5)

mtext("Plot 4C: Hazard Ratio for Burn Type",
      side = 3,
      line = -1,
      outer = TRUE)
```

Plot 4C shows the hazard ratio between different burn types. We notice that the hazard ratio is not constant between "Flame" and any other burn types, which tends to increase over time. In this case, we need to perform stratification based on "Flame" vs. "Non-Flame" when fitting with Cox model.     

```{r, results='hide'}
# survival prob different for different burn type
sub1 = burn[which(burn$BurnType!="Electric"),]
bs1 = with(sub1,Surv(time=T3, event=D3))
survdiff(bs1~BurnType,data=sub1)
survdiff(burn.surv~BurnType, data=burn)
```
                   

* Based on log-rank test, chemical, scald and flame burn type do not have significantly different survival function (p=0.5); electric burn type does have significantly different survival function from the others (p=0.02). In this case, we are going to create a new variable to separate electric burn type from others.        


```{r}
ind_flame = mapvalues(burn$BurnType, from=c("Chemical","Scald","Electric","Flame"),
                                    to=c("NonFlame","NonFlame","NonFlame","Flame"))

ind_electric = mapvalues(burn$BurnType, from=c("Chemical","Scald","Electric","Flame"),
                                    to=c("NonElectric","NonElectric","Electric","NonElectric"))
burn["BurnType2"] = ind_flame
burn["BurnType3"] = ind_electric
```


```{r}
KMcurves.flame <- survfit(burn.surv ~ BurnType2, data = burn)
KMcurves.electric <- survfit(burn.surv ~ BurnType3, data = burn)


plot(KMcurves.flame, col = 1:2, lwd=1.5, main = "KM Curves for Flame and Non-Flame")
legend("bottomright",c("Non-Flame","Flame"), col=1:2, lwd=1.5)


plot(KMcurves.electric, col = 1:2, lwd=1.5, main = "KM Curves for Electric and Non-Electric")
legend("bottomright",c("Non-Electric","Electric"), col=1:2, lwd=1.5)


```
```{r, results='hide'}
survdiff(burn.surv~BurnType2, data=burn)
survdiff(burn.surv~BurnType3, data=burn)
```
               
* The plots above give the survival function estimates based on the two indicator variables. Flame and Non-Flame burn types do not differ in infection survival (p=0.3), but have non-proportional hazards; Electric and Non-Electric burn types do differ in infection survival (p=0.004), with electric burn type being more infection-risky, and have proportional hazards.         


#### 5. Are antibiotic treatment or surgical excision survival impacted by treatment types?     
```{r}
burn.surv2 = Surv(time=burn$T2,event=burn$D2)
burn.KM2 <- survfit(burn.surv2 ~ Treatment, data = burn)

plot(burn.KM2, col=1:2, lwd=1.5,
     main="Plot 5A: Kaplan-Meier estimate for Antibiotic Treatment",
     xlab="Survival time (Days)",
     ylab="Survival Probability")
abline(h=0.5, col=3, lty=2, lwd=2)

legend("bottomright",c("Routine Care","Total Body Cleansing"), col=1:2, lwd=1.5)
```
```{r}
survdiff(burn.surv2 ~ Treatment, data=burn)
```

Plot 5A depicts the survival probability for antibiotic treatment over time. It seems that higher proportion of patients with total body cleansing are treated with prophylactic antibiotic treatment than the control group. Based on log-rank test, the survival functions for prophylactic antibiotic treatment are significantly different (p=0.009) between two treatment types at $\alpha=0.05$.       


```{r}
burn.surv3 = Surv(time=burn$T1,event=burn$D1)
burn.KM3 <- survfit(burn.surv3 ~ Treatment, data = burn)

plot(burn.KM3, col=1:2, lwd=1.5,
     main="Plot 5B: Kaplan-Meier estimate for Surgical Excision",
     xlab="Survival time (Days)",
     ylab="Survival Probability")
abline(h=0.5, col=3, lty=2, lwd=2)

legend("bottomright",c("Routine Care","Total Body Cleansing"), col=1:2, lwd=1.5)
```

```{r}
survdiff(burn.surv3 ~ Treatment, data=burn)
```

Plot 5B shows the survival probability for surgical excision over time. Again, higher proportion of patients in the treatment group received surgical excision than the control group. Based on log-rank test, the survival functions for surgical excision are significantly different (p=0.007) between two treatment types at $\alpha=0.05$.


```{r, results='hide'}
for (x in c("SiteHead","SiteButtock","SiteTrunk","SiteUpperLeg","SiteLowerLeg","SiteRespTract")) {
  print(x)
  print(with(burn, table(burn[,x])))
}

# for (x in c("SiteHead","SiteButtock","SiteTrunk","SiteUpperLeg","SiteLowerLeg","SiteRespTract")) {
#   print(x)
#   tab = with(burn, table(D3, burn[,x]))
#   print(tab[2,2]/(tab[2,2]+tab[1,2]))
# }

for (x in c("SiteHead","SiteButtock","SiteTrunk","SiteUpperLeg","SiteLowerLeg","SiteRespTract")) {
  print(x)
  tab = with(burn, table(Treatment, burn[,x]))
  print(tab[2,2]/(tab[2,2]+tab[1,2]))
}
```

#### 6. Do patients with wounds at some burn site tend to have higher infection rate or Treatment rate?         

##### Chart: Burn Site and Percentage of Infection and Treatment
Burn Site | Percentage of Patients | Burned Infection Rate | Burned Treatment Rate
------ | ------ | ------ | ------ | ------ | ------
Head  | 54.5% | 34.3% | 52.9%
Buttock | 22.7% | 40% | 62.9%
Trunk | 84.4% | 32.3% | 57.7%
Upper Leg | 40.9% | 31.7% | 50.8%
Lower Leg | 30.5% | 27.7% | 59.6%
Respiratory Tract | 29.2% | 37.8% | 46.7%


From the char above, we can see that among all burn sites, it is the most common for patients to have burn wounds at trunk (84.4% of patients have burn wounds at trunk). Nevertheless, patients with trunk wounds do not have disproportionately higher infection rate than the others. On the contrary, only 22.7% of patients have burn wounds at buttock, but the infection rate is the highest among all burn sites (40%). No disproportionality is detected in terms of treatment received for patients with different burn sites. Note that one patient could have multiple burn sites. The percentage of one burn site do not reflect a single case but may have overlaps with other burn sites.            


> ## IV. Model Building

### Cox Model with Time-Independent Variable

```{r, results="hide"}

# check if electric burn type should be included
cox.burntype3.included = coxph(burn.surv~Treatment
                                +strata(BurnType2)+BurnType3, data=burn)
cox.burntype3.not = coxph(burn.surv~Treatment+strata(BurnType2), data=burn)
anova(cox.burntype3.not, cox.burntype3.included)

# therefore, we include electric burn type
```

```{r, results="hide"}

# check if all burn site variables should be included
cox.burnsite.included = coxph(burn.surv~Treatment+SiteHead+SiteButtock+SiteTrunk+SiteUpperLeg+SiteLowerLeg+SiteRespTract
                                +strata(BurnType2)+BurnType3, data=burn)
cox.burnsite.not = coxph(burn.surv~Treatment+strata(BurnType2)+BurnType3, data=burn)
anova(cox.burnsite.not, cox.burnsite.included)

# therefore, burn site variables are not significant as a whole
```

```{r, results="hide"}
# test for each burn site
drop1(cox.burnsite.included, test="Chisq")
# burn site buttock is significant while the others are not; also significant are tretament and burntype3
```


```{r, results="hide"}

# check if percent burned should be included
cox.percburn.included = coxph(burn.surv~Treatment
                                +strata(BurnType2)+BurnType3+PercentBurned, data=burn)
cox.percburn.not = coxph(burn.surv~Treatment+strata(BurnType2)+BurnType3, data=burn)
anova(cox.percburn.not, cox.percburn.included)

# therefore, we do not include percent burned
```


```{r, results="hide"}

# check if percent burned should be included
cox.gender.included = coxph(burn.surv~Treatment
                                +strata(BurnType2)+BurnType3+Gender, data=burn)
cox.gender.not = coxph(burn.surv~Treatment+strata(BurnType2)+BurnType3, data=burn)
anova(cox.gender.not, cox.gender.included)

# therefore, we do not include gender
```

```{r, results="hide"}

# check if site buttock should be included
cox.siteb.included = coxph(burn.surv~Treatment
                                +strata(BurnType2)+BurnType3+SiteButtock, data=burn)
cox.siteb.not = coxph(burn.surv~Treatment+strata(BurnType2)+BurnType3, data=burn)
anova(cox.siteb.not, cox.siteb.included)

# we still include percent burned even if only significant at 0.1; may be meaningful for interpretation
```


```{r}
time.ind.cox = coxph(burn.surv ~ strata(BurnType2)+Treatment+BurnType3+SiteButtock, data=burn)
summary(time.ind.cox)
```


#### Interpretation:      
 
Based on the model (with only time-independent variables), Treatment (whether or not the cleansing detergent is used) and BurnType3 (Electric vs. Non-Electric) are significant at $\alpha=0.05$; Site-Buttock (whether or not burn wound is present at buttock) is significant at $\alpha=0.1$ and not significant at $\alpha=0.05$.            

* Patients who received body cleansing with the detergent have 0.472 times the risk of getting infected than those who did not receive it on average. We are 95% confident that the true ratio in risk of infection between treatment group and control group is between 0.26 and 0.85.        

* Patients who were electrically burned have 4 times the risk of being infected than those with other burn types, on average. We are 95% confident that the true ratio in risk of infection between patients with electric burn type and other burn types is between 1.27 and 12.78. Note that the model estimate for electric burn type may be biased due to insufficient sample size.       

* Patients who were burned at buttock have 1.89 times the risk of being infected than those who were not, on average. We are 95% confident that the true ratio in risk of infection between patients who had burn wound at buttock and those who had not is between 0.98 and 3.62.                

#### Model Checking: 

```{r}
# no multicolinearity present
data.frame(VIF=vif(time.ind.cox))
```

```{r}
zph.time.ind = cox.zph(time.ind.cox)

plot(zph.time.ind[1], main = "Plot A1: Schoenfeld Residual for Treatment")
```

```{r}
plot(zph.time.ind[2], main = "Plot A2: Schoenfeld Residual for BurnType:Electric")
```
```{r}
plot(zph.time.ind[3], main = "Plot A3: Schoenfeld Residual for SiteButtock")
```
```{r}
# Cox-Snell transformation
cox_snell <- burn$D3-residuals(time.ind.cox, type="martingale")

# Cum. Hazard for cox-snell residual
cs_surv <- Surv(cox_snell, burn$D3)
cs_fit <- survfit(cs_surv~1,type="fleming-harrington")

plot(cs_fit,fun="cumhaz", xlab="Cox-Snell Residuals", ylab="Cumulative Hazard")
abline(0,1, col=2, lwd=2, lty=2)
title("Plot A4: Cumulative Hazard of Cox-Snell Residuals")
```


* Based on VIF, we do not conclude any multicolinearity.       
* We do not detect any significant pattern in Schoenfeld residual plots (A1, A2, A3), which means that the proportional hazard assumption holds.    
* The cumulative hazard of Cox-Snell residuals follows along the straight line with slope 1, which means that our model gives a good fit.    

```{r}
rmart = residuals(time.ind.cox,type="martingale")
# deviance residual
rdev = residuals(time.ind.cox,type="deviance")
# df beta
rdfb = residuals(time.ind.cox,type="dfbeta")

# linear predictor
preds = predict(time.ind.cox)
```

```{r}
# plot
plot(preds,rmart,xlab="Linear Predictor",
     ylab="Martingale Residual", ylim=c(-4,2), pch = 19, cex = 0.5)
text(preds, rmart+0.2, labels = rownames(burn), cex=0.8)
title("Martingale Residuals vs. Linear Predictor")
# 32, 93
```

```{r}
plot(preds,rdev,xlab="Linear Predictor",
     ylab="Deviance Residual", ylim=c(-3,3.5), pch = 19, cex = 0.5)
text(preds, rdev+0.2, labels = rownames(burn), cex=0.8)
title("Deviance Residuals vs. Linear Predictor")
# 93, 79, 32, 58
```
            
```{r}
plot(preds,rdfb[,1],xlab="Linear Predictor",
     ylab="dfbeta for Prison Record", ylim=c(-0.07,0.07), pch = 19, cex = 0.5)
text(preds, rdfb[,1]+0.005, labels = rownames(burn), cex=0.8)
title("dfbeta Values by Observation Order for Treatment")

# 93, 153, 115, 47
```
```{r}
plot(preds,rdfb[,2],xlab="Linear Predictor",
     ylab="dfbeta for Prison Record", ylim=c(-0.2,0.2), pch = 19, cex = 0.5)
text(preds, rdfb[,2]+0.01, labels = rownames(burn), cex=0.8)
title("dfbeta Values by Observation Order for BurnType: Electric")
# 75, 58, 93, 32, 33, 139
```
```{r}
plot(preds,rdfb[,3],xlab="Linear Predictor",
     ylab="dfbeta for Prison Record", ylim=c(-0.13,0.1), pch = 19, cex = 0.5)
text(preds, rdfb[,3]+0.01, labels = rownames(burn), cex=0.8)
title("dfbeta Values by Observation Order for BurnSite: Buttock")
# 47, 29, 93
```

##### Observations to Examine by Residuals and Influence     

* Martingale Residuals: 32, 93       

* Deviance Residuals: 93, 79, 32, 58         

* Treatment Influence: 93, 153, 115, 47       

* BurnType: Electric Influence: 32, 93, 33         
 
* BurnSite: Buttock Influence: 47, 29, 93        

* The important observations that we needs to examine are: 32, 47, 93

```{r}
unusualpts <- c(32, 47, 93)
burn[unusualpts,c("Treatment","SiteButtock","BurnType", "T3", "D3")]
```
```{r, results='hide'}
quantile_electric = ecdf(burn$T3[which(burn$BurnType=="Electric")])
quantile_electric(16)

quantile_routine = ecdf(burn$T3[which(burn$Treatment=="Routine")])
quantile_routine(46)
```
 
* Observation 32: Has the worst burn type (electric) and treatment (routine) combination, but was not infected and the survival time was 16 days, which is at the 90th percentile among patients with electric burn type.     

* Observation 47: Has burn wound at buttock and received routine treatment, but was not infected and the survival time was 46 days, which is at the 91th percentile among patients with routine care.      

* Observation 93: Has the best treatment (cleansing) and site (not buttock) combination, but was infected after a quite short period of time (5 day).      

     

### Cox Model with Time-Dependent Variable        

```{r, results='hide'}
burn2 <- tmerge(burn,burn,Obs,tstop=T3)
burn2 <- tmerge(burn2,burn,Obs,antibiotic=tdc(T2))
burn2 <- tmerge(burn2,burn,Obs,excision=tdc(T1))


status <- as.integer(with(burn2,(tstop==T3 & D3)))
burn2 <- data.frame(burn2, status)
burn2


```



```{r, results='hide'}
burn.surv.t <- Surv(time=burn2$tstart,time2=burn2$tstop,event=burn2$status,type="counting")
drop1(coxph(burn.surv.t ~ strata(BurnType2)+BurnType3+excision+Treatment+SiteButtock+antibiotic, data=burn2), test="Chisq")
```


```{r, results='hide'}
cox2.butt.included <- coxph(burn.surv.t ~ strata(BurnType2)+excision+SiteButtock, data=burn2)
cox2.butt.not <- coxph(burn.surv.t ~ strata(BurnType2)+excision, data=burn2)

anova(cox2.butt.not, cox2.butt.included)
# not include site buttock
```

```{r, results='hide'}
cox2.treat.included <- coxph(burn.surv.t ~ strata(BurnType2)+Treatment+excision, data=burn2)
cox2.treat.not <- coxph(burn.surv.t ~ strata(BurnType2)+excision, data=burn2)

anova(cox2.treat.not, cox2.treat.included)
# not include treatment
```
```{r, results='hide'}
cox2.burntype3.included <- coxph(burn.surv.t ~ strata(BurnType2)+BurnType3+Treatment+excision, data=burn2)
cox2.burntype3.not <- coxph(burn.surv.t ~ strata(BurnType2)+excision+Treatment, data=burn2)

anova(cox2.burntype3.not, cox2.burntype3.included)
# not include burn type: electric
```


```{r}
time.dep.cox <- coxph(burn.surv.t ~ strata(BurnType2)+excision+Treatment+BurnType3, data=burn2)
# time.dep.cox <- coxph(burn.surv.t ~ factor(Z1)+SiteButtock+strata(Z11), data=burn2)
summary(time.dep.cox)
```

#### Interpretation:      
 
Based on the model (starting out with both time-independent and time-dependent variables), excision (whether or not surgical excision is performed) is significant at level 0.05; treatment (whether or not the cleansing detergent is used) and BurnType3 (Electric vs. Non-Electric) are significant at level 0.1.

* Those patients who received surgical excision have 0.37 times the risk of getting infected than those who did not receive it, on average. We are 95% confident that the true ratio in risk of infection between patients who received surgical excision and those who did not is between 0.14 and 0.96.    

* Those patients who received cleansing treatment have 0.58 times the risk of getting infected than those who did not receive it, on average. We are 95% confident that the true ratio in risk of infection between patients who received cleansing treatment and those who did not is between 0.32 and 1.04.     

* Those patients who have electric burn type have 3 times the risk of getting infected than those who did not receive it, on average. We are 95% confident that the true ratio in risk of infection between patients who received cleansing treatment and those who did not is between 0.97 and 9.26.     


#### Model Checking: 


```{r}
zph.time.dep = cox.zph(time.dep.cox)

plot(zph.time.dep[1], main = "Plot B1: Schoenfeld Residual for Excision (Y/N)")
```
```{r}
plot(zph.time.dep[2], main = "Plot B2: Schoenfeld Residual for Treatment")
```
```{r}
plot(zph.time.dep[3], main = "Plot B3: Schoenfeld Residual for BurnType: Electric")
```


```{r}
# Cox-Snell transformation
cox_snell <- burn2$status-residuals(time.dep.cox, type="martingale")

# Cum. Hazard for cox-snell residual
cs_surv <- Surv(cox_snell, burn2$status)
cs_fit <- survfit(cs_surv~1,type="fleming-harrington")

plot(cs_fit,fun="cumhaz", xlab="Cox-Snell Residuals", ylab="Cumulative Hazard")
abline(0,1, col=2, lwd=2, lty=2)
title("Plot B4: Cumulative Hazard of Cox-Snell Residuals")
```

* We do not detect any significant pattern in Schoenfeld residual plots (B1, B2, B3), which means that the proportional hazard assumption holds.     
* The cumulative hazard of Cox-Snell residuals follows along the straight line with slope 1 in general, with some deviation at the tail. We conclude that our model gives a moderately good fit.      



```{r}
rmart = residuals(time.dep.cox,type="martingale")
# deviance residual
rdev = residuals(time.dep.cox,type="deviance")
# df beta
rdfb = residuals(time.dep.cox,type="dfbeta")

# linear predictor
preds = predict(time.dep.cox)
```

```{r}
# plot
plot(preds,rmart,xlab="Linear Predictor",
     ylab="Martingale Residual", ylim=c(-2,2), pch = 19, cex = 0.5, col=2)
text(preds, rmart+0.15, labels = rownames(burn), cex=0.8)
title("Martingale Residuals vs. Linear Predictor")
# 2, 94, 51
```

```{r}
plot(preds,rdev,xlab="Linear Predictor",
     ylab="Deviance Residual", ylim=c(-3,3.5), pch = 19, cex = 0.5, col=2)
text(preds, rdev+0.2, labels = rownames(burn), cex=0.8)
title("Deviance Residuals vs. Linear Predictor")
# 2, 94, 51
```
            
```{r}
plot(preds,rdfb[,1],xlab="Linear Predictor",
     ylab="dfbeta for Excision", ylim=c(-0.3,0.3), pch = 19, cex = 0.5, col=2)
text(preds, rdfb[,1]+0.02, labels = rownames(burn), cex=0.8)
title("dfbeta Values by Observation Order for Excision")

# 2, 4, 128, 6

```

```{r}
plot(preds,rdfb[,2],xlab="Linear Predictor",
     ylab="dfbeta for Treatment", ylim=c(-0.15,0.15), pch = 19, cex = 0.5, col=2)
text(preds, rdfb[,2]+0.01, labels = rownames(burn), cex=0.8)
title("dfbeta Values by Observation Order for Treatment")

# 2, 51
```

```{r}
plot(preds,rdfb[,3],xlab="Linear Predictor",
     ylab="dfbeta for BurnType: Electric", ylim=c(-0.3,0.3), pch = 19, cex = 0.5, col=2)
text(preds, rdfb[,3]+0.02, labels = rownames(burn), cex=0.8)
title("dfbeta Values by Observation Order for BurnType: Electric")

# 6, 7, 102, 51, 94
```



##### Observations to Examine by Residuals and Influence     

* Martingale Residuals: 2, 94, 51   

* Deviance Residuals: 2, 94, 51         

* Excision Influence: 2, 4, 128, 6    

* Treatment Influence: 2, 51    

* BurnType: Electric Influence: 6, 7, 102, 51, 94
 
* The important observations that we needs to examine are: 2, 6, 94, 51

```{r}
unusualpts <- c(2, 6, 94, 51)
burn2[unusualpts,c("excision", "status", "T3", "BurnType","Treatment")]
```

* Observation 2: Was not infected but had a short survival time (9 days). The observation may be heavily censored.     
* Observation 6: Had a short survival time (4 days).

* Observation 94: Had an extremely short survival time (1 day).

* Observation 51: Had a comparatively long survival time among patients with electric-burned wounds.      




> ## V. Conclusion

We have examined the relationship between the straphylocous infection and various other variables. The conclusions are as follows:     

* At significance level 0.05, the infection survival for treatment group is significantly different from control group; total body cleansing with the detergent tended to have better survival than those who received routine care (50% to 60% less likely to be infected on average).   

* There is some weak quadratic relationship between percent of burned area and infection time: with low percent of burned area, higher percentage is associated with longer time to infection; with high percent of burned area, higher percentage tend to coincide with less time to infection. Such relationship remains dubious.

* Percent of burned area, the only indicator of burn severity in our dataset, is not significant in Cox hazard model. It may be useful to consider other possible metrics that describe burn severity (e.g. burn degree) in further investigation.      

* Based on five number summary (min, 25th, median, 75th, max), patients who were infected tend to have higher percent of burned area. Nevertheless, percent of burned area is not a significant factor in the hazard model.       

* Patients with different gender do not diff significantly in infection survival.            

* Patients who are non-white have significantly different survival function from white patients; non-white patients tend to have higher survival rate overall, based on our data. Some further clinical investigation may be needed to confirm if non-white patients are less likely to be infected than white patients.           

* For the four burn types: Patients with chemical and scald burns have very high risk of infection during the first week; patients with electric and flame burns have the lowest survival rate (at around 50%) by the end of study; patients with flame burns have disproportionate hazard than the others; patients with electric burns have significantly higher hazards than the other groups (200% more likely to be infected on average).         

* The survival functions for antibiotics are significantly different between patients who received cleansing treatment and patients who received routine care. Patients who received cleansing treatment tend to have higher chance of getting antibiotic treatment. This suggests that treatment assignment may not be random.      

* The survival functions for surgical excision are significantly different between patients who received cleansing treatment and patients who received routine care. Patients who received cleansing treatment tend to have higher chance of surgical excision. This also suggests that treatment assignment may not be random.         

* Burn sites as a whole is not an important factor in explaining changes in hazard rate; however, based on the first model with time-independent variables, patients who had buttock burn wounds tend to have lower survival probability than those who had not at significance level 0.1. (35% less likely to be infected on average)         


Several potential sources of bias:    

1. Sample sizes for burn types that are not 'flame' (especially 'chemical') are small.   

2. Sample size for non-white patients are small.

3. Treatment assignment may not be random at all: patients with worse burn wounds, who had higher chance of receiving antibiotic treatment and/or surgical excision, may had been be more likely to receive detergent cleansing during assignment.                

4. The quadratic relationship between percent of burned area and infection time is dubious.           














